#!/bin/bash

err=0

echo "Verifying C code style..."

CFILES=$(git diff --cached --name-only | grep -E ".*\.[hc]" | grep -vf .format-exclude)

err=0
for file in $CFILES; do
  # check stashed version only
  git show :$file | clang-format-14 -n --Werror --style=file || err=1
done

echo "Verified C files: $CFILES"

if [ $err -eq 1 ]; then
  exit 1
fi

# Verify Python code style

echo "Verifying Python code style..."
PYFILES=$(git diff --cached --name-only | grep -E ".*\.py")
PYEXTRA=$(git diff --cached --name-only | grep -E "launch")

err=0
for file in $PYFILES; do
  git show :$file | pycodestyle - || err=1
done

for file in $PYEXTRA; do
  git show :$file | pycodestyle - || err=1
done

echo "Verified Python files: $PYEXTRA $PYFILES"

if [ $err -eq 1 ]; then
  exit 1
fi

echo "Code style OK"
