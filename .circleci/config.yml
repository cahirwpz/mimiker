version: 2
jobs:
  build:
    working_directory: ~/mimiker
    docker:
      - image: rafalcieslak/mimiker-build-base:1.0
    steps:
      - run: apt-get install curl
      - run:
          name: 'Trigger other jobs'
          command: |
            # One day this function will become a CircleCI built-in.
            echo $CIRCLE_API_TOKEN
            function trigger_job() {
              job_name=$1
              curl --user ${CIRCLE_API_TOKEN}: \
                --data build_parameters[CIRCLE_JOB]=$job_name \
                --data revision=$CIRCLE_SHA1 \
                https://circleci.com/api/v1.1/project/github/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/tree/$CIRCLE_BRANCH
            }          
            trigger_job verify-formatting
            trigger_job verify-pep8
      - checkout
      - run:
          name: 'Make'
          command: 'make'
      - store_artifacts:
          path: mimiker.elf
          prefix: kernel_image
      - store_artifacts:
          path: initrd.cpio
          prefix: ramdisk
      - run:
          name: 'Run kernel tests'
          command: './run_tests.py --thorough'

  verify-formatting:
    working_directory: ~/mimiker
    docker:
      - image: rafalcieslak/mimiker-build-base:1.0
    steps:
      - checkout
      - run: './verify-format.sh'

  verify-pep8:
    working_directory: ~/mimiker
    docker:
      - image: rafalcieslak/mimiker-build-base:1.0
    steps:
      - checkout
      - run: './verify-pep8.sh'